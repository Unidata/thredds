<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

  <title>TDS Viewer Links</title><style type="text/css">
  pre {font-size: 9pt; padding: 10px; background-color: #E7E7E7; border: 1px solid #CFCFCF; width: 85%;}
  code {font-size: 11pt;}
  dl {margin: 10px 5px 5px 15px;)
  </style></head>
<body>
<h1><img src="../images/unidataLogo.png" align="middle" height="75" width="75">Adding Viewer Links</h1>
<hr>
<p>The TDS adds <em><strong>Viewer Links</strong></em> to datasets at the bottom of a dataset's HTML web page, for example:</p>
<p><img src="../images/StaticViewer.jpg" alt="Viewers" border="2" height="488" width="573"></p>
<p>Currently, the TDS automatically adds a NetCDF-Java Tools link to
any direct dataset that has an ID. It adds an IDV link to any dataset
that has an OPENDAP service, and has a DataType of <em>GRID</em>.</p>
<p>The TDS also supports several ways to configure other viewer links and their results:&nbsp;</p><p>You can add your own viewer links in these ways:</p>
<ol>
  <li><a href="#Adding_a_viewer_link_with_a_viewer">Add a viewer link by adding a "viewer" property element to&nbsp;dataset</a>, explicitly listing the URL of the viewer.</li>
  <li><a href="#Create_a_Viewer_implementation_Java">Add a viewer link by creating a Java class</a> that tells the TDS what datasets are viewable, and what HTML fragment to include.</li><li>If your viewer link points to a JNLP file, <a href="#Returning_a_JNLP_file_">the TDS can generate the JNLP file</a> from a template file.</li>
</ol><hr style="width: 100%; height: 2px;">
<h2><a name="Adding_a_viewer_link_with_a_viewer"></a>Adding a viewer link with a "viewer" property element&nbsp; </h2>
<p>This method is available in TDS version 3.17+.</p><p>To add a viewer
link to a specific dataset, add a "viewer" property element to the
dataset element in the TDS configuration catalog.When the TDS generates
an HTML dataset page, it looks for a
"viewer" property element in the dataset and, if it finds one, uses the
value of the property element to generate a viewer link. The value of
the "viewer" property element must be a string containing a URL and a
name separated by a a comma. An HTML link is built using the URL and
the name. For instance,&nbsp;the following example:</p><pre style="margin-left: 40px;">&lt;dataset&nbsp;name="Test Viewer" ID="testViewer" serviceName="dapService" urlPath="test/testData.nc" dataType="Grid"&gt;<br>  <strong>&lt;property name="viewer" value="http://www.unidata.ucar.edu/staff/caron/,MyViewer"/&gt;<br></strong>&lt;/dataset&gt;<br></pre><p>gives the URL as "http://www.unidata.ucar.edu/staff/caron/"&nbsp;and the name as "MyViewer".</p><p>So the resulting HTML fragment&nbsp;is:</p><pre style="margin-left: 40px;">&lt;a href='<strong>http://www.unidata.ucar.edu/staff/caron/</strong>'&gt;<strong>MyViewer</strong>&lt;/a&gt;</pre><p>Which looks like:</p><pre style="margin-left: 40px;"><a href="http://www.unidata.ucar.edu/staff/caron/">MyViewer</a></pre><h3>Adding viewer links to many datasets</h3><span style="font-weight: bold;"></span><p>When
a "viewer" property element is contained in an inherited metadata
element, it will apply to all the descendants of the containing
dataset. For instance, the following example will result in viewer
links for all children datasets:</p><pre style="margin-left: 40px;">&lt;dataset name="Test inherited viewer" ID="tiv"&gt;<br>  &lt;<strong>metadata inherited="true"</strong>&gt;<br>    &lt;serviceName&gt;all&lt;/serviceName&gt;<br>    &lt;property name="<strong>viewer</strong>" value="<strong>http://www.unidata.ucar.edu/staff/caron/,MyViewer</strong>" /&gt;<strong><br></strong>&nbsp; &lt;/metadata&gt;<br>  &lt;dataset name="test inherited viewer ds 1" ID="tiv/ds1" urlPath="tiv/ds1.nc"&gt;<br>  &lt;dataset name="test inherited viewer ds 2" ID="tiv/ds2" urlPath="tiv/ds2.nc"&gt;<br>&lt;/dataset&gt;</pre><p>When added to a <code>datasetScan</code> elements, the "viewer" property results in a viewer link being added to the HTML dataset pages for each generated dataset:</p><pre style="margin-left: 40px;">&lt;datasetScan name="Test inherited viewer dsScan" ID="tivScan"<br>             path="tivScan" location="C:/some/good/data/"&gt;<br>  &lt;<strong>metadata inherited="true"</strong>&gt;<br>    &lt;serviceName&gt;all&lt;/serviceName&gt;<br>    &lt;property name="<strong>viewer</strong>" value="<strong>http://www.unidata.ucar.edu/staff/caron/,MyViewer</strong>" /&gt;<strong><br></strong>&nbsp; &lt;/metadata&gt;<br>&lt;/datasetScan&gt;</pre>

<h3>Adding the Dataset URL to the Viewer Link</h3>
<p>However, adding the same viewer link to all your dataset pages may
not be what you want. The TDS also supports inserting a dataset access
URL into the viewer link URL. If your dataset has a single service, you
can place "<strong>{url}</strong>" into your viewer link. The datasets access URL will be substituted in place of the "<strong>{url}</strong>" string. For instance, the following:</p><pre style="margin-left: 40px;">&lt;dataset name="Test Viewer2" ID="testViewer2" serviceName="dapService" urlPath="test/testData.nc" dataType="Grid"<br>  &lt;property name="viewer" value="http://localhost:8080/cdmValidator/validate?dataset=<strong>{url}</strong>,Validation Service"/&gt;<br>&lt;/dataset&gt;<br></pre>
<p>results in the following viewer link:</p><pre style="margin-left: 40px;">&lt;a href="http://localhost:8080/cdmValidator/validate?dataset=http://localhost:8080/thredds/dodsC/test/testData.nc"&gt;<br>  Validation Service&lt;/a&gt;</pre><h3>Selecting the Dataset access URL used in the Viewer Link</h3>
<p>When a Dataset has more than one kind of access, each access will
have a seperate URL. Use the service type inside of curly brackets to
select which access URL to use.</p><p>For example, the following:</p><pre style="margin-left: 40px;">&lt;service name="all" type="Compound" base=""&gt;<br>  &lt;service name="dap" type="<strong>OPENDAP</strong>" base="<strong>/thredds/dodsC/</strong>" /&gt;<br>  &lt;service name="wcs" type="<strong>WCS</strong>" base="<strong>/thredds/wcs/</strong>" /&gt;<br>&lt;/service&gt;<br>&lt;dataset name="test viewer select service" ID="tvss"&gt;<br>  &lt;metadata inherited="true"&gt;<br>    &lt;serviceName&gt;all&lt;/serviceName&gt;<br>  &lt;/metadata&gt;<br><br>  &lt;dataset name="test viewer select service ds 1" ID="tvss/ds1" urlPath="tvss/ds1.nc"&gt;<br>    &lt;property name="viewer" value="http://localhost:8080/cdmValidator/validate?dataset={<strong>OPENDAP</strong>},Validation Service" /&gt;<br>  &lt;/dataset&gt;<br>  &lt;dataset name="test viewer select service ds 2" ID="tvss/ds2" urlPath="tvss/ds2.nc"&gt;<br>    &lt;property name="viewer" value="http://localhost:8080/cdmValidator/validate?dataset={<strong>WCS</strong>},Validation Service" /&gt;<br>  &lt;/dataset&gt;<br>&lt;/dataset&gt;</pre><p>generates a viewer link URL for the first dataset of:</p><pre style="margin-left: 40px;">http://localhost:8080/cdmValidator/validate?dataset=http://localhost:8080<strong>/thredds/dodsC/</strong>tvss/ds1.nc</pre><p>and for the second dataset:</p><pre style="margin-left: 40px;">http://localhost:8080/cdmValidator/validate?dataset=http://localhost:8080<strong>/thredds/wcs/</strong>tvss/ds2.nc<br></pre><hr style="width: 100%; height: 2px;"><h2><a name="Returning_a_JNLP_file_"></a>Returning a JNLP file</h2><p>Viewer
links can also support on the fly generation of JNLP files. This can be
very useful when using data viewing software that can be
started&nbsp;with a JNLP file (i.e., running under <a href="http://java.sun.com/products/javawebstart/">Java Webstart</a>).
For instance, the automatically generated "IDV" and "NetCDF-Java Tools"
viewer links mentioned above use JNLP files to start. The JNLP
generation can be used in other user configured viewer links as well.</p><h3>Adding&nbsp;JNLP Template Files</h3><p>The TDS will return any JNLP template file under the&nbsp;<code>${catalina_home}/content/thredds/views/</code> directory when requested with a URL that looks like:</p><pre style="margin-left: 40px;">http://localhost:8080<strong>/thredds/view/</strong>&lt;filename&gt;</pre><p>For example, the URL</p><pre style="margin-left: 40px;">http://localhost:8080/thredds/view/<strong>my/cool/viewer.jnlp</strong></pre><p>will look for and return the file</p><pre style="margin-left: 40px;">${catalina_home}/content/thredds/views/<strong>my/cool/viewer.jnlp</strong></pre><h3>Adding Dataset Information to the JNLP Template File</h3><p>The
TDS processes the JNLP template file before sending it to the client as
the response to their request. The processing looks for replacement
strings of the form "{<em>name</em>}" and replaces them with the value
of the corresponding URL query parameter. So, if the JNLP template file
contains any occurrences of the "<strong>{dataset}</strong>" string and the request URL looked like</p><pre style="margin-left: 40px;">http://localhost:8080/thredds/view/my/cool/viewer.jnlp?dataset=http://some.other.server/thredds/dodsC/cool/data.nc</pre><p>all occurrences of "<strong>{dataset}</strong>" would be replaced by "http://some.other.server/thredds/dodsC/cool/data.nc".</p><p>So, looking at an approximation of the IDV JNLP file:</p><pre style="margin-left: 40px;">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br>&lt;!-- JNLP File for Integrated Data Viewer --&gt;<br>&lt;jnlp spec="1.0+" codebase="http://www.unidata.ucar.edu/software/idv/webstart/"&gt;<br>  &lt;information&gt;<br>    &lt;title&gt;Integrated Data Viewer&lt;/title&gt;<br>    &lt;vendor&gt;Unidata&lt;/vendor&gt;<br>    &lt;homepage href="http://www.unidata.ucar.edu/software/idv/index.html"/&gt;<br>    &lt;description&gt;Integrated Data Viewer(IDV)&lt;/description&gt;<br>    &lt;description kind="short"&gt;A tool for geoscientific analysis and visualization.<br>    &lt;/description&gt;<br>    &lt;icon href="IDV/idv.gif"/&gt;<br>    &lt;offline-allowed/&gt;<br>  &lt;/information&gt;<br>  &lt;security&gt;<br>   &lt;all-permissions/&gt;<br>  &lt;/security&gt;<br>  &lt;resources&gt;<br>   &lt;j2se version="1.4+" max-heap-size="512m"/&gt;<br>   &lt;jar href="IDV/idv.jar"/&gt;<br>   &lt;extension name="IDV Base" href="IDV/idvbase.jnlp"/&gt;<br>  &lt;/resources&gt;<br>  &lt;application-desc main-class="ucar.unidata.idv.DefaultIdv"&gt;<br>   &lt;argument&gt;-data&lt;/argument&gt;<br>   &lt;argument&gt;type:opendap.grid:<strong>{dataset}</strong>&lt;/argument&gt;<br>  &lt;/application-desc&gt;<br>&lt;/jnlp&gt;</pre><p>The third from the last line would be replaced with</p><pre style="margin-left: 40px;">    &lt;argument&gt;type:opendap.grid:<strong>http://some.other.server/thredds/dodsC/cool/data.nc</strong>&lt;/argument&gt;</pre><p>Which passes the dataset access URL to the IDV as an argument.</p><hr>
<h2><a name="Create_a_Viewer_implementation_Java"></a>Create a  Viewer implementation Java class </h2>
<p>This method is available in TDS version 3.14+.</p>
<p>This technique gives you full control over whether your viewer link
appears, and what the URL looks like. You must create a Java class
which implements the <strong>thredds.servlet.Viewer</strong> interface: </p>
<pre style="margin-left: 40px;">public interface <strong>Viewer<br></strong>{<br><strong> (1)</strong> public boolean <strong>isViewable</strong>( thredds.catalog.InvDatasetImpl dataset);<br><strong> (2)</strong> public String <strong>getViewerLinkHtml</strong>( InvDatasetImpl ds, HttpServletRequest req);<br>}</pre>
<ol>
  <li>  Your class is passed a <strong>thredds.catalog.InvDatasetImpl</strong> object, and it  returns true if it is viewable by your viewer.</li>
  <li>Your class is passed a viewable <strong>thredds.catalog.InvDatasetImpl</strong>, and it must return a well-formed HTML string that has an <em><strong>href</strong></em> link in it.</li>
</ol>
<p><strong>Example</strong>:</p>




<pre style="margin-left: 40px;">package my.package;<br>include thredds.catalog.*;<br><br>public class IDV implements Viewer<br>{<br>  &nbsp;public boolean <strong>isViewable</strong>( InvDatasetImpl ds)<br>  &nbsp;{<br>      InvAccess access = ds.getAccess(ServiceType.DODS);<br>      if (access == null) access = ds.getAccess(ServiceType.OPENDAP);<br><strong>1)</strong>    if (access == null) return false;<br><br><strong>2)</strong>    return (ds.getDataType() == DataType.GRID);<br>   }<br><br>   public String <strong>getViewerLinkHtml</strong>( InvDatasetImpl ds, HttpServletRequest req)<br> &nbsp; {<br>      InvAccess access = ds.getAccess(ServiceType.DODS);<br><strong>3)</strong>    if (access == null) access = ds.getAccess(ServiceType.OPENDAP);<strong><br>4)</strong>    URI dataURI = access.getStandardUri();<br>      try<br>   &nbsp;  {<br>         URI base = new URI( req.getRequestURL().toString());<br><strong>5)</strong>       dataURI = base.resolve( dataURI);<br>      }<br>   &nbsp;  catch (URISyntaxException e)<br>   &nbsp;  {<br>         log.error("Resolve URL with "+req.getRequestURL(),e);<br>      }<br><br><strong>6) </strong>   return "&lt;a href='<strong>/thredds/view/idv.jnlp</strong>?url="+dataURI.toString()+"'&gt;Integrated Data Viewer (IDV) (webstart)&lt;/a&gt;";<br>   }<br>}<br></pre>
<ol>
  <li>Requires there to be  OPeNDAP access for the dataset. </li>
  <li>Requires the dataset to be of <strong>DataType.GRID</strong>. </li>
  <li>Get the OPeNDAP access object for the dataset.</li>
  <li>Get the access URI.</li>
  <li>Resolves the access URI against the request, which turns it into an absolute URI</li>
  <li>
Forms the HTML string to be placed on the dataset's TDS web page. Note
that is has an href embedded in it, which will be displayed in this
example as: <blockquote>
    <p><a href="http://motherlode.ucar.edu:8080/thredds/view/idv.jnlp?url=http://motherlode.ucar.edu:8080/thredds/dodsC/model/NCEP/NDFD/CONUS_5km/NDFD_CONUS_5km_20061106_1200.grib2">Integrated Data Viewer (IDV) (webstart)</a></p>
    </blockquote>
  </li>
</ol>
<h3>Referencing an external URL</h3>
<p>If the viewer you want to reference is not part of the TDS, just make the href  absolute, e.g.:</p>
<pre style="margin-left: 40px;">&lt;a href='http://my.server/viewer?<strong>url=http://motherlode.ucar.edu:8080/thredds/dodsC/model/data.grib2</strong>'&gt;My Server&lt;/a&gt;</pre>
<p>In this example, the server would see the OPeNDAP data access URL and remotely read it.</p><h3>Loading your class at runtime</h3>
<p>You must place your Viewer class into  <strong>the ${tomcat_home}/webapps/thredds/WEB-INF/lib </strong>or<strong> classes </strong>directory<strong>. </strong>(Previous instructions to place it into  the <strong>${tomcat_home}/shared</strong> directory doesn't work, because of classloader problems). </p>
<p>Then tell the TDS to load it by adding a line to the <strong>${tomcat_home}/content/thredds/threddsConfig.xml</strong> file, for example:</p>
<pre style="margin-left: 40px;">&lt;viewer&gt;my.package.MyViewer&lt;/viewer&gt;<br></pre><h3>Using a Generated JNLP File</h3><p>A
Viewer implementation can still use the TDS JNLP template service (<a href="#Returning_a_JNLP_file_">see above</a>). It
just needs to return the appropriate HTML link referencing an existing
JNLP template file and giving the appropriate replacment URL query
parameters. The IDV implementation above does just that.</p><p>One
reason to write an implementation of Viewer and use is JNLP is if the
viewer has requirements for the datsets it can handle. Looking at the
IDV implementation above we see it enforces two requirements:</p><ol><li>the dataset must have an OPeNDAP (aka DODS) access URL and</li><li>the dataset must be gridded data.</li></ol>
<hr width="100%">
<address>
  <img src="../images/thread.png" height="108" width="110">
  This document is maintained by Unidata and was last updated
  March 2009. Send comments to
  <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS support</a>.
</address>
</body></html>