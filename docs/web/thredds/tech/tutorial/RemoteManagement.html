<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html><head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><title>Remote Management</title>  
</head>
<body>


<div class="head">
  <h1>TDS Remote Management Tutorial </h1>
  <address>
  </address>
  <hr>
  <div class="head"></div>
  <h2>Introduction</h2>
  <p>It's very convenient to be able to remotely manage and administer the Tomcat web server, and to remotely configure and debug the Thredds Data Server, for example from a web browser running on your desktop. However, remote access to the server introduces potential security problems, so by default these capabilities are not turned on. You can run Tomcat and TDS quite successfully by editing the configuration files on the server, and restarting when needed. </p>
  <p>Managing a server is difficult and we recommend that you  enable remote  management. By following the procedures here, you can do so without opening any big security holes. However, you must decide this yourself, based on your organization's security policies, and a risk assessment for your server. In what follows we try to explain what risks the various options have, as well as we understand them. A good compromise may be to do all the work to enable remote management, then turn it on only while actively configuring the server, and turn it off when in production mode. </p>
  <p>In any case, we strongly recommend that you also read and follow the <a href="TomcatSecurity.html">Tomcat/TDS Security guidelines</a>. </p>
</div>
<h2>Configuring Tomcat Users </h2>
<p>Special permissions (like remote management) are done in Tomcat by creating <em><strong>users</strong></em> with special <em><strong>roles</strong></em>. As long as you also follow the <a href="TomcatSecurity.html">Tomcat/TDS Security guidelines</a>, using the simplest Tomcat mechanism to do this should be safe. </p>
<p> Edit <strong>${tomcat_home}/conf/tomcat-users.xml</strong>, adding roles "tdsConfig", "manager", &quot;admin&quot;, and users who have those roles, e.g.:</p>
<blockquote>
  <pre>&lt;?xml version='1.0' encoding='utf-8'?&gt;<br>&lt;tomcat-users&gt;<br>  &lt;role rolename="manager"/&gt;<br>  &lt;role rolename="admin"/&gt;<br>  &lt;role rolename="tdsConfig"/&gt;
<br>  &lt;user username="admin" password="adminpassword" roles="admin, manager"/&gt;<br>  &lt;user username="yername" password="yerpassword" roles="tdsConfig"/&gt;<br>&lt;/tomcat-users&gt;</pre>
</blockquote>
<p>The <em><strong>manager</strong></em> and <em><strong>admin</strong></em> roles are used within Tomcat itself to allow the use of the manager and administrator web interface. The <em><strong>tdsConfig</strong></em> role is used to configure the TDS. These roles must be specified exactly as shown. Note that all 3 of these roles are independent - you can add any, all or none of them. The easiest way to enable or disable remote administration is to change this file and restart Tomcat.</p>
<p>The list of users, their names and passwords, are whatever you want them to be. Note that after you get this set up, you can manage users remotely through the administrator interface. Note also that before you go into production mode, you should change to using digest passwords by following the instructions <a href="TomcatSecurity.html#Digest">here</a>. </p>
<p>Note that any changes wont take effect until you restart Tomcat. </p>
<p><strong>Higher Security: </strong>You can also use an LDAP server or a Database to store users and roles, which may give you higher levels of security. Use of this feature is beyond the scope of this documentation, however.</p>
<h2><a name="keystore">Enable Secure Sockets Layer (SSL)</h2>
<p>We  ensure that no one can intercept and read sensitive information to and from the server (through doing what's called <em>network sniffing</em>) by encrypting the information using SSL. To enable this, do the following: </p>
<ol>
  <li>Create a certificate keystore by executing the following command:
    <blockquote>
  <pre><strong>${java_home}/bin/keytool -genkey -alias tomcat -keyalg RSA -validity 365</strong></pre>
  </blockquote>
    <p>    You will then get a set of prompts:</p>
    <blockquote>
      <pre>Enter keystore password: <strong>changeit</strong></pre>
      <pre>What is your first and last name? [Unknown]: <strong>www.mydomain.edu</strong></pre>
      <pre>What is the name of your organizational unit? [Unknown]: </pre>
      <pre>What is the name of your organization? [Unknown]: </pre>
      <pre>What is the name of your City or Locality? [Unknown]: </pre>
      <pre>What is the name of your State or Province? [Unknown]: </pre>
      <pre>What is the two-letter country code for this unit? [Unknown]: </pre>
      <pre>Is CN=*.ucar.edu, OU=UCAR Web Engineering Group, O=University Corporation for Atmospheric Research, L=Boulder, ST=Colorado, C=US correct?</pre>
      <pre>[no]: yes</pre>
      <pre>Enter key password for &lt;tomcat&gt;</pre>
      <pre>(RETURN if same as keystore password):</pre>
    </blockquote>
    <p>Be sure to  specify a password value of "changeit" and the web address of your Tomcat server for &quot;first and last name&quot;. The other values fill out as appropriate. This creates a <em>self-signed certificate</em> and puts it into the JDK's default keystore. Note the <strong>validity</strong> option on the command line, which is the number of days the certificate is valid. See <a href="http://java.sun.com/j2se/1.4.2/docs/tooldocs/windows/keytool.html">keytool documentation</a> for full description of managing keystores. </p>
  <li>
    <p>Edit <strong>${tomcat_home}/conf/server.xml</strong>, find the following section and uncomment it so it looks like: </p>
    <pre>    &lt;!-- Define a SSL Coyote HTTP/1.1 Connector on port 8443 --&gt;<br>    &lt;Connector port=&quot;8443&quot; <br>               maxThreads=&quot;150&quot; minSpareThreads=&quot;25&quot; maxSpareThreads=&quot;75&quot;<br>               enableLookups=&quot;false&quot; disableUploadTimeout=&quot;true&quot;<br>               acceptCount=&quot;100&quot; debug=&quot;0&quot; scheme=&quot;https&quot; secure=&quot;true&quot;<br>               clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; /&gt;</pre>
  This enables Tomcat to use port 8443 for the HTTPS protocol, which uses SSL. All sensitive accesses will get redirected to that port.</li>
</ol>
<blockquote>
  <p> Note that if you choose to use a different port than 8443, you must also change the <strong>redirectPort=&quot;8443&quot;</strong> attribute on the regular (8080) Connector element in server.xml. </p>
</blockquote>
<h3>Using a separate keystore </h3>
<p>You might prefer to keep your Tomcat keystore separate from the default JDK keystore, or to use a different password. Then modify the above as:</p>
<pre><strong>		</strong>${java_home}/bin/keytool -genkey -alias tomcat -keyalg RSA<strong> -<strong>keystore <strong>-validity 365</strong> &quot;/data/path/mykeystore&quot; </strong></strong></pre>
<pre>    &lt;Connector port=&quot;8443&quot; <br>               maxThreads=&quot;150&quot; minSpareThreads=&quot;25&quot; maxSpareThreads=&quot;75&quot;<br>               enableLookups=&quot;false&quot; disableUploadTimeout=&quot;true&quot;<br>               acceptCount=&quot;100&quot; debug=&quot;0&quot; scheme=&quot;https&quot; secure=&quot;true&quot;<br>               clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot;
               <strong>keystoreFile=&quot;/data/path/mykeystore&quot; keystorePass=&quot;mypassword&quot;</strong> /&gt;</pre>
<h3><strong>Installing a Certificate from a Certificate Authority</strong></h3>
<p>The use of SSL in this way prevents a network sniffer from getting your password. A more sophisticated (and more difficult to perform) attack is the so called <em>man-in-the-middle</em> attack where someone pretends to be your server, and induces your client to send the password to it. </p>
<p>In the above,  we used self-signed certificates, and your browser will give you a warning  each time you access a web page that uses self-signed certificates. It will allow you to choose to continue however, and so a clever enough attacker might induce you to accept their self-signed certificate. To prevent this, you can obtain a certificate signed by a <em>Certificate Authority</em> (CA). You can then install it using <a href="http://jakarta.apache.org/tomcat/tomcat-5.0-doc/ssl-howto.html#Installing%20a%20Certificate%20from%20a%20Certificate%20Authority">these instructions</a>. The browser will see that its a valid certificate, and so you will never accept self-signed certificates and you will preclude man-in-the-middle attacks.</p>
<p>Obtaining and installing a CA signed certificate is a fair amount of work, but not really all that difficult. We recommend it if you plan on  leaving remote management  enabled in production mode.</p>
<h3>Checking that the correct ports are enabled</h3>
<p>After restarting Tomcat, you can use <strong>netstat -an </strong>command to check that the ports are correctly configured. You should see lines like:</p>
<pre>  TCP    127.0.0.1:8080         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:8443         0.0.0.0:0              LISTENING 
</pre>
<p>You also need to make sure that your firewall is allowing those ports through. </p>
<h2>TDS Remote Debugging</h2>
<p>Once SSL is enabled, you can remotely debug and configure the TDS.</p>
<p>Debugging information is available at <strong><a href="http://localhost:8080/thredds/debug">http://localhost:8080/thredds/debug</a>. </strong>Some features of particular interest are:</p>
<ol>
  <li><strong>Show Log</strong>s allows you to look at the TDS access logs, to see who is using your server.</li>
  <li><strong>Reinitialize</strong> will reread in the TDS catalogs and reinitialize itself, without having to restart the server. Use this whenever you make changes to the TDS catalogs.</li>
  <li><strong>Show Catalog Errors</strong> shows you any errors when reading the TDS catalogs. Check this after you run Reinitialize.</li>
</ol>
<p>TDS catalogs can be modified remotely through HTTPS GET and PUT commands that work on the &quot;raw&quot;catalog.xml using a special URL. For example, the main catalog will have the URL <strong><a href="http://localhost:8080/thredds/content/catalog.xml">http://localhost:8080/thredds/content/catalog.xml</a>. </strong>The NetCDF ToolsUI is currently under development to make this convenient to do. </p>
<h2><a name="tomcat"></a>Tomcat Remote Management</h2>
<p>The best way to secure the  Tomcat manager and administration webapps is to restrict what IP addresses can access them. To do so:</p>
<ol>
  <li>Edit <strong>${tomcat_home}/conf/Catalina/localhost/admin.xml</strong> and uncomment the boldface line:
    <pre>&lt;Context path=&quot;/admin&quot; docBase=&quot;${catalina.home}/server/webapps/admin&quot;<br>        debug=&quot;0&quot; privileged=&quot;true&quot;&gt;</pre>
    <pre> &lt;!-- Uncomment this Valve to limit access to the Admin app to localhost
   for obvious security reasons. Allow may be a comma-separated list of
   hosts (or even regular expressions). --&gt;
<strong> &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; allow=&quot;127.0.0.1&quot;/&gt;</strong></pre>
    <pre> &lt;Logger className=&quot;org.apache.catalina.logger.FileLogger&quot;
   prefix=&quot;localhost_admin_log.&quot; suffix=&quot;.txt&quot;
   timestamp=&quot;true&quot;/&gt;</pre>
    <pre>&lt;/Context&gt;
       </pre>
  </li>
  <li>Edit <strong>${tomcat_home}/conf/Catalina/localhost/manager.xml</strong> and add the following boldface line: </li>
</ol>
<blockquote>
  <pre>&lt;Context path=&quot;/manager&quot; docBase=&quot;${catalina.home}/server/webapps/manager&quot;<br>        debug=&quot;0&quot; privileged=&quot;true&quot;&gt;

  <strong>&lt;Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="127.0.0.1"/&gt;</strong></pre>
  <pre>  &lt;!-- Link to the user database we will get roles from --&gt;
  &lt;ResourceLink name=&quot;users&quot; global=&quot;UserDatabase&quot; type=&quot;org.apache.catalina.UserDatabase&quot;/&gt;</pre>
  <pre>&lt;/Context&gt;
    </pre>
</blockquote>
<p>The above uses the allow value <strong>"127.0.0.1"</strong> which will restrict access to &quot;localhost&quot;, that is, the machine that the Tomcat server is running on. You may change the <em><strong>allow</strong></em> value to an IP address, a list of IP address or a subnet, eg:</p>
<ul>
  <li> 
    <p><strong>allow="128.117.140.62"</strong></p>
  </li>
  <li>
    <p><strong>allow="128.117.140.62, 128.117.140.63, 128.117.140.99"</strong></p>
  </li>
  <li>    <strong>allow="128.117.140.*"</strong></li>
</ul>
<p>You can also use the <em><strong>RemoteHostValve</strong></em> to filter by host name, eg: </p>
<blockquote>
  <pre><strong>&lt;Valve className="org.apache.catalina.valves.RemoteHostValve" allow="(*.).ucar.edu"/&gt;
   </strong></pre>
</blockquote>
<h2>TroubleShooting</h2>
<ul>
  <li><strong>Connection refused when trying to access a restricted page</strong>. The SSL socket is not enabled in the server.xml file, or you didn't install a certificate in the keystore. </li>
  <li><strong>What's in the keystore? </strong>
    <ul>
      <li>Look at the <a href="http://localhost:8080/manager/status">Tomcat Server Status</a> page and check  the JVM Version.</li>
      <li> From command line, make sure that this matches the results of <strong>'java -version'. </strong>If not, then your Tomcat server is starting up with a different JVM. </li>
      <li>From command line, <strong>'keytool -list' </strong>will show you what's in the default keystore. Standard is to have password <em>changeit</em>. You need an entry named <em>tomcat</em>. </li>
    </ul>
  </li>
</ul>
<h2>Running without SSL</h2>
<p>If you are on a secure network, and don't want to run with SSL enabled, edit <strong>${tomcat_home}webapps/thredds/WEB-INF/web.xml</strong> and change all instances of CONFIDENTIAL to NONE.</p>
<p>Password authentication will then be done without SSL encryption. You will have to repeat this whenever you reinstall or upgrade thredds.war.</p>
<h2>Resources</h2>
<ul>
  <li> <a href="http://jakarta.apache.org/tomcat/tomcat-5.0-doc/ssl-howto.html">Tomcat SSL Configuration</a> </li>
  <li>Java Secure Sockets Extension (JSSE) <a href="http://java.sun.com/j2se/1.4.2/docs/guide/security/jsse/JSSERefGuide.html">Reference Guide</a> </li>
  <li>JDK <a href="http://java.sun.com/j2se/1.4.2/docs/tooldocs/windows/keytool.html">keytool</a> application </li>
</ul>
<hr WIDTH="100%">
<address>
<img src="../images/thread.png" width="110" height="108">This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated on Oct 24, 2006
</address>
<p>&nbsp;
</p>
</body>
</html>
