<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <title>Tomcat Tour and Security</title>
</head>

<body>

<h1><img src="../images/THREDDSlogo.jpg" height="54" width="67">Basic Tomcat Tour and Tomcat Security </h1>
<hr>

At this point we assume that Tomcat is installed in
<code> /home/workshop/tds/apache-tomcat-6.0.13 </code>
and that you have an environment variable TOMCAT_HOME set to this value.
<p>
    Check that this variable is set by with this command:
<p>
    <code> echo $TOMCAT_HOME</code>
<p>

    If the system indicates that the variable is not set, recall that you can
    set this variable in any window at any time by executing the command:
<p>
<code> set TOMCAT_HOME /home/workshop/tds/apache-tomcat-6.0.13  </code>
<p>
(This command works under the UNIX bash shell, which is the shell running on
our workshop machines.  You may need to use a different command if running
under some other shell.)


<a name="Tomcat Tour" />
<h1> Tomcat Tour</h1>

<a name="ImportantDirs" />
<h2>Important Tomcat Directories </h2>

<h3> The <code> webapps </code> Directory </h3>
<p>
    The <code> webapps </code> directory is where web applications are placed to be
    run by Tomcat.  Tomcat automatically monitors this directory and when it finds
    a new
    <code>.war</code> file it will attempt to install it as an application.  If
    there is an error in the deployment, such as a problem with the file, it will report
    that in the the log file <code> catalina.out</code>.
<p>
<b>Exercise:</b> Do this:
<p>
<code>ls $TOMCAT_HOME/webapps</code>
<p>
    Among other things, you should see the <code> thredds.war </code> file that was previously installed,
    and a directory called <code> thredds</code>.  This is the TDS code.
    Tomcat installed the TDS automatically in a directory named
    <code>thredds</code>when the <code>thredds.war</code> file was placed there.


<p>
<h3> The <code> logs </code> Directory    </h3>
<p>
    Once Tomcat has been started it will generate some log files and put them in
    the <code>logs </code> directory.  The files
    that are generated depends on how the server is configured.  Here is an
    example from one recent Tomcat installation using the default configuration:
<pre>
[tomcat@lead3 ~/logs]$ ls -lt
total 12
-rw-r--r-- 1 tomcat leadstaff  234 Jul 26 11:49 localhost.2007-07-26.log
-rw-r--r-- 1 tomcat leadstaff 1597 Jul 26 11:49 catalina.2007-07-26.log
-rw-r--r-- 1 tomcat leadstaff 1710 Jul 26 11:49 catalina.out
-rw-r--r-- 1 tomcat leadstaff    0 Jul 26 11:49 localhost_access_log.2007-07-26.txt
-rw-r--r-- 1 tomcat leadstaff    0 Jul 26 11:49 admin.2007-07-26.log
-rw-r--r-- 1 tomcat leadstaff    0 Jul 26 11:49 host-manager.2007-07-26.log
-rw-r--r-- 1 tomcat leadstaff    0 Jul 26 11:49 manager.2007-07-26.log
</pre>

<b>Exercise:</b> Do this:
<p>
    <code> ls $TOMCAT_HOME/logs </code>
</p>
<p> The log file <code> <b>catalina.out</b> </code> is Tomcat's main log file and can be worth
    watching when
    Tomcat is started or when an web application is placed in the <code> webabbs </code> directory
    to ensure that no errors occurred.  A successful launch of Tomcat generates lots of entries
    in <code>catalina.out</code>, but that stream of entries generally ends with a line
    like this, which indicates a successful start up:
<pre>
Jul 26, 2007 11:49:09 AM org.apache.catalina.startup.Catalina start
INFO: Server startup in 5080 ms
</pre>

<p>
    Similarly, if there seems to a problem in the execution of Tomcat
    or a web application, <code> catalina.out </code> is good place to look for an error.  Or, just check the
    <code>logs </code> directory for the file most recently written and see if any errors are reported
    there.</p>
<p>
    The <code> <b>localhost_access_log </b></code> file (such as
    <code>localhost_access_log.2007-07-26.txt </code> in the example above)
    is useful in both Tomcat and TDS administration because it tracks all requests made to the Tomcat
    server and the response given by the server.   For example, this line:
<pre>
128.117.156.28 - - [26/Jul/2007:11:59:54 -0700] "GET /thredds/tdr/storm/catalog.html HTTP/1.1" 200 2139
</pre>
shows that a request arrived from a host with the IP address 128.117.156.28
on July 26 to retrieve the document
/thredds/tdr/storm/catalog.html using HTTP protocol
version 1.1.  It also shows that the server returned the HTTP status code 200, which means <q>OK</q> and
that the request succeeded, and the number of bytes sent.
(See <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP Status Code Definitions </a>
for the meaning of response codes returned by HTTP.)


<a name="content Dir" />
<h3> The <code> content </code> Directory   </h3>
The <code><b>content</b></code> directory is the place to put documents to
be served by tomcat.  This includes TDS catalogs.
<p>
<b>Exercise:</b> Do this:
<pre>
ls $TOMCAT_HOME/content
</pre>
<p>
You should see the <code>thredds</code>  directory.  Now do:
<pre>
ls $TOMCAT_HOME/thredds
</pre>
<p>
You should some default content placed when the TDS was installed in order
    to get you started. In particular, you should see a file called 
    <code>catalog.xml</code>, which is the top TDS catalog.  When you visit
    <a href="http://localhost:8080/thredds">http://localhost:8080/thredds </a>, this is the catalog that
    the TDS renders in HTML and sends to your browser.


<a name="conf Dir" />
<h3> The <code> conf </code> Directory   </h3>

The <code><b>conf</b></code> directory holds files used to configure Tomcat.
In this document we will focus on the files <code>tomcat-users.xml</code> and <code>server.xml</code>.
<p>
    <b>Exercise:</b> Do this:

<pre>
        ls $TOMCAT_HOME/conf
    </pre>
<code>tomcat-users.xml</code> contains information about users of the application served by
tomcat.  It holds user names, passwords, and defines user <q>roles</q>, which can used
to limit access to various pieces of functionality of a application.  It is discussed
further <a href="#Tomcat Manager"> below</a>.
<p>



    <a name="conf/server.xml" />
<h2> The Server Configuration File <code>conf/server.xml</code> </h2>
The file <code>server.xml</code> is used to configure Tomcat.  It is an XML file that contains
elements to configure various aspects of Tomcat.
See <a href="http://tomcat.apache.org/tomcat-5.0-doc/config/">Tomcat Server Configuration Reference </a>
    for more information about <code>server.xml</code>.
Here we will focus on a few select concepts and XML elements relevant to setting up a TDS.
<p>
Changes to <code>server.xml</code>do not take effect until Tomcat is restarted.
<p>
    <b>Exercise:</b> View <code>$TOMCAT_HOME/conf/server.xml</code> in your favorite
    editor.   Find the elements below as we tour the file.


<a name="Top Level Elements" />
<h3> Top Level Elements </h3>

<p>
The outermost element of <code>server.xml</code>  is a <code>Server</code> element,
which represents the entire Tomcat servlet container and defines its
    characteristics as a whole.
<p>
A <code>Service</code> element is a nested element with the <code>Server</code>
    element.  It represents the combination of one or more <code>Connector</code>
    components that share a single <code>Engine</code> component.
    (An <code>Engine</code> represents the entire request processing machinery
    associated with a <code>Service</code>.)
    The <q>top</q> Tomcat service is named <q>Catalina</q>. (Hence the log
file name of <q>catalina.out</q>.)


    <a name="Port Config" />
<h3> Port Configuration: Server and Connector Elements </h3>

Tomcat listens for requests on port 8080 (which is why your local Tomcat
splash page can be reached via
<a href="http://locahost:8080/"> http://locahost:8080/</a>).  This is set
via a <q>Connector</q> element in <code>server.xml</code>.  A Connector element
represents the interface between external clients sending requests to
and receiving responses from Tomcat.  This element can
take additional attributes for further configuration.  Here is an example
that came with a recent Tomcat installation:
<pre>
       &lt;Connector port="8080"
               maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
               enableLookups="false" redirectPort="8443" acceptCount="100"
               debug="0" connectionTimeout="20000"
               disableUploadTimeout="true" /&gt;
</pre>

<p>
Tomcat listens for a shutdown command on port 8005.  Keeping
the shutdown functionality on a separate port provides enhanced security because
shutdown commands can't be received from an external source.  This port is defined in
the main <q>Server</q> element.  Here is the first line
of that element, illustrating the shutdown port 8005:
<pre>
&lt;Server port="8005" shutdown="SHUTDOWN" debug="0"&gt;
</pre>

<p>

The other important port for secure Tomcat and TDS management is port 8443, which
    is the port
on which Tomcat listens for secure connections.   Like port 8080, this
is defined via a Connector attribute.   This particular connector may
be commented out in a default installation.  We will enable it when we configure Tomcat to use SSL encryption, below.  For
illustration, here is an example of a Connector for port 8443:
<pre>
    &lt;Connector port="8443"
               maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
               enableLookups="false" disableUploadTimeout="true"
               acceptCount="100" debug="0" scheme="https" secure="true"
               keystoreFile="/opt/tomcatlead2/jakarta-tomcat-5.0.28/conf/keystore-tomcat"
               clientAuth="false" sslProtocol="TLS" /&gt;
</pre>

<a name="Access Log Config" />
<h3> Access Logging Configuration: Valve Elements </h3>

A <code>Valve</code> element is a way to preprocess requests sent to Tomcat.
Of particular interest here is the Access Log Valve, which creates log files
to track client access information, as we saw in the access_log file above.
As we saw, this valve can be used to a variety of information, including 
page hit counts, user session activity, user authentication
information, and other information.
<p>
Attributes to this valve are used to configure the information reported
in the log file.  Here is an example of a simple Access Log Valve that came
    with a recent Tomcat distribution:
<pre>
&lt;Valve className="org.apache.catalina.valves.AccessLogValve"
                 directory="logs"  prefix="localhost_access_log." suffix=".txt"
                 pattern="common" resolveHosts="false"/&gt;
</pre>
This is the valve that produced the log entries we saw above.  The <code>pattern</code> attribute of this element defines a formatting layout.
<q>common</q> is a standard format.  But a pattern can also be defined by
a literal text string, rather like how C language strings are formatted.
Here is an example of the version of the Access Log Valve used on our TDS
server:
<pre>
&lt;Valve className="org.apache.catalina.valves.AccessLogValve"
                 directory="logs"  prefix="access." suffix=".log"
                 pattern="%h %l %u %t &quot;%r&quot; %s %b &quot;%{Referer}i&quot; &quot;%{User-Agent}i&quot; %D"
                 resolveHosts="false"/>
</pre>
This produces log entries that look like this:
<pre>
 128.117.126.9 - - [23/Jun/2007:23:52:42 -0600] "GET /thredds/catalog/fmrc/NCEP/GFS/Global_2p5deg/catalog.html HTTP/1.0" 200 4014 "null" "www.dlese.org,support@dlese.org" 30463
</pre>

<p>
    For more  information about the pattern codes supported by the Access Log Valve, see
<a href="http://tomcat.apache.org/tomcat-5.0-doc/config/valve.html"> The Valve Component </a>.
<p>
<b>Exercise:</b> Enable this valve so that we can see Tomcat requests and responses.

    <a name="User Database Config" />
<h3> User Database Configuration: Realm Elements </h3>

Realms allow the protected resources on a server to be partitioned into a set of 
protection spaces, each with its own authentication scheme and/or authorization
database.
A Tomcat <code>Realm</code> is implemented as a <q>database</q> of usernames and
    passwords that identify valid users of a web application or set of web
    applications. </p>
<p>
We will use <code>Realm</code> elements below in configuring Tomcat to
use digested passwords.



<a name="tomcat security" />
<h1>Tomcat Security</h1>

We believe Tomcat to be secure enough for typical scientific uses. There are no known security
exploits or weaknesses. However, the Internet is a wild place, and we are not security experts so caveat emptor.

<p>
In this section we introduce Tomcat security by enabling authentication in order
    to use the Tomcat Manager application.  The Tomcat Manager is
    an application that is distributed with the Tomcat distribution, which provides a graphical user
interface to manage Tomcat.      
    We will then enable Secure Socket Layer
    (SSL) encryption of requests to the TDS <q>debug</q> application.  The TDS
    <q>debug</q> application provides an interface to manage
the TDS remotely.  Because each application provides access to sensitive functionality,
it is necessary to secure them by requiring users to authenticate to Tomcat and by requiring
    SSL encryption of the information that is sent to Tomcat.  Finally, we describe
    how to make the Manager more secure by enabling SSL encrypted communication
    to the Manager.


<a name="authentication" />
<h2> Using Authentication to Restrict Access to Tomcat Applications</h2>

Although by default Tomcat does not require authentication to access the resources
it controls, it can be configured to do so.   From a TDS perspective, authentication
is required to 1) get access to the tomcat manager application, and 2) enable remote
TDS management.
<p>
    This section introduces the Tomcat authentication mechanism by describing how to
    enable authentication in order to use the Tomcat manager.   (Enabling remote
    TDS management is described under <q>Tools for Managing TDS, Using Remote Management</q>.)
<p>
 We'll start this section with background material about the Manager and the file
    <code>tomcat-users.xml</code>, then provide detailed information about the steps required
    to enable authentication.  In a nutshell,
    there are two steps required to enable authentication for the Tomcat Manager:
<ul>
    <li>Configure <code>tomcat-users.xml</code>with the required role and user information</li>
    <li>Restart Tomcat to pick up the changes</li>
</ul>






<a name="Tomcat Manager" />
<h3> The Tomcat Manager </h3>

The Tomcat Manager is an application that allows users to deploy, undeploy, or
reload an application such as the TDS without having to shut down and restart tomcat.
See the
<a href="file:///opt/tomcat/server/webapps/manager/html-manager-howto.html"> Tomcat Manager Tutorial </a>
for more information about using the Manager.
The tomcat distribution contains this application, but for security reasons it is
disabled by default.

The Tomcat manager is a <q>webapp</q>, just like TDS.  However being considered part
of the Tomcat server, it resides in a different
directory than the <code>webapps</code> directory we toured above, which exists for external applications.
Instead, the Manager webapp is placed under <code>$TOMCAT_HOME/server/webapps</code>.

<p>
    Execution of the tomcat manager requires that users authenticate themselves and
    be associated with the predefined role <q>manager</q>.  That is, users must provide
    a user name and password, and their user name must be associated with the
    manager role.  By default, this information is stored in the file
    <code>${TOMCAT_)HOME}/conf/tomcat-users.xml</code>.




<a name="tomcat-users" />
<h3> tomcat-users.xml</h3>
<code>tomcat-users.xml</code> is an ASCII file in which user names, passwords, and
roles are stored for the purpose of authentication and limiting access to protected
resources.
For our purposes, <code>tomcat-users.xml</code> provides an effective mechanism for
protecting TDS
resources.  However, for increased security you could consider using an LDAP server
or a database to store user and role information.  Use of these mechamisms is beyond
the scope of this documentation,
however.

<p>
Here is an example of a very simple <code>tomcat-users.xml</code> file:

<pre>
&lt;tomcat-users&gt;
    &lt;role rolename="tdrAdmin /&gt;
    &lt;user name="Anne" password="secret" roles="tdrAdmin" />
&lt;/tomcat-users&gt;
</pre>

There must be an entry in the file for each user that is required to authenticate.
Each <code>&lt;user&gt;</code> entry defines the user name, password, and roles that are assigned to
that user. In this example there is one role defined, <q>tdrAdmin</q>.  There
is also one user, <q>Anne</q>, with the password <q>secret</q> and she is
assigned the role <q>tdrAdmin</q>.
<p>
    You can think of roles as similar
to groups in Unix-like operating systems, because access to specific web
application resources is granted to all users possessing a particular role
(rather than enumerating the list of associated usernames). A particular user
can have any number of roles associated with their username.
</p>
<p>
    When a user
    attempts to access a protected resource for the first time, Tomcat will challenge
    the user for a user name and password.  Once the user has been authenticated, the
    relevant information, including the roles to which the user was assigned, is
    cached for the duration of the user&#146;s login.
<p>
    <code>tomcat-users.xml</code> is read once when Tomcat is started.  For this reason, changes to
    <code>tomcat-users.xml</code> will not be recognized until Tomcat is restarted.








<h3> Configure <code>tomcat-users.xml</code> with User Info and Roles </h3>


In order to allow a user to execute the manager, the user's name and password must
be added to the <code>tomcat-users.xml</code> file, and the user must be assigned the <q>manager</q>
role, which is a predefined role in Tomcat.

<p>
    Role names such as <code> manager </code> should be added to the <q>role</q>
    attribute of a
    <code> &lt;user&gt; </code>
    element.  The value of the role attribute can be a single value or a comma separated
    list of values.  For example, to add the manager role to the user <q>Anne</q> in the above
    example, the result would look like this:
<pre>
    &lt;tomcat-users&gt;
        &lt;role rolename="tdrAdmin /&gt;
        &lt;role rolename="manager" /&gt;
        &lt;user name="Anne" password="secret" roles="tdrAdmin,manager" /&gt;
    &lt;/tomcat-users&gt;
</pre>

<h3>Restart Tomcat</h3>
Be sure to restart Tomcat for the changes to take effect.
<p>
    <b>Exercise:</b>  Modify the default <code> tomcat-users.xml</code> to add yourself as a user and give
    yourself the role of <q>manager</q>.  Start (or restart) Tomcat, and ensure that you can
    access the manager application.

<p>
    Test this change by pointing your browser to <a href="http://localhost:8080"> http://localhost:8080 </a>
    and then click
    on the <q>Manager</q> link in the left hand column.  You&#146;ll see that you will not be
    challenged on getting the Tomcat splash page, but you will be challenged when you
    try to access the manager.
<p>
With access to the Manager enabled, you can now start, stop, and reload the TDS without having
to start or stop Tomcat.
<p>
    <b>Exercise:</b> This exercise is to help you learn to debug tomcat problems.
    Modify tomcat-users.xml, but make sure there&#146;s some problem with the XML format.
    For example, leave off a closing angle bracket.  In the logs directory
    (~tomcat/logs) tail the file catalina.out as you restart Tomcat.  The log
    file should report some kind of error that would, in theory, lead you to
    reexamine tomcat-users.xml and help you find the error.





<a name="digested passwords" />
<h2> Using Digested Passwords </h2>

At this point in our tour of Tomcat security we have passwords stored as clear text, which is a
security vulnerability if the host is compromised.  Tomcat also supports digested passwords, a type
of encoding, but it must configured to use them.  Then, when a
client (like Firefox) makes a request, Tomcat will tell the client that a digested
    password is required. Based on this dialog, the client
    will automatically digest the password entered by the user.
<p>
    There are several digest algorithms.  Here we will use the SHA (Secure Hash
    Algorithm) algorithm.

<h3> Configuring Tomcat to Use Digested Passwords </h3>
There are three tasks required to configure Tomcat use digested passwords:
<ul>
    <li> Configure <code>server.xml</code> to use digested passwords</li>
    <li> Create the digested passwords and put them in <code>tomcat-users.xml</code></li>
    <li> Restart Tomcat</li>
</ul>



<h4> Configure <code>server.xml</code> to Use Digested Passwords</h4>

    The Tomcat distribution comes with this Realm enabled in <code>server.xml</code>:
<pre>

      &lt;!-- This Realm uses the UserDatabase configured in the global JNDI
      resources under the key "UserDatabase".  Any edits
      that are performed against this UserDatabase are immediately
      available for use by the Realm.  --&gt;
      &lt;Realm className="org.apache.catalina.realm.UserDatabaseRealm"
             resourceName="UserDatabase"&gt;

</pre>
We will not use this Realm and instead create a new one using the Tomcat
<q>MemoryRealm</q>.  Find the above Realm definition in <code>server.xml</code>,
comment it out, and add this new Realm:
<pre>
      &lt;Realm className="org.apache.catalina.realm.MemoryRealm" digest="SHA" /&gt;
</pre>
<p>
The result should look something like this:
<pre>
      &lt;!--Realm className="org.apache.catalina.realm.UserDatabaseRealm"
             resourceName="UserDatabase"/--&gt;

      &lt;!--  Added by Anne --&gt;
      &lt;Realm className="org.apache.catalina.realm.MemoryRealm" digest="SHA"/&gt;
</pre>



<h4> Create and Store the Digested Passwords</h4>

Tomcat provides a script, <code>digest.sh</code>, that creates a digested
version of a password.  The script takes an argument that specifies which digest algorithm
to use.  It also takes an argument that is the password to be digested.  Here is
an example of the command usage:

<pre>
    $TOMCAT_HOME/bin/digest.sh -a SHA secret
</pre>
This will produce output like this:
<pre>
    secret:e5e9fa1ba31ecd1ae84f75caaa474f3a663f05f4
</pre>
which shows the digested form of the password <q>secret</q>.
<p>
If you get output like this:
<pre>
    (anne) lead3: /opt/tomcat 6 % bin/digest.sh -a SHA secret
    /opt/tomcat/bin/setclasspath.sh: line 58: [: =: unary operator expected
    secret:e5e9fa1ba31ecd1ae84f75caaa474f3a663f05f4
</pre>
don&#146;t worry about the error.  The digested password is still correct.
<p>
You must the copy the digested password, the part to the right of the colon character,
    into <code>tomcat-users.xml</code> in place of the clear text
    password.

<h4> Restart Tomcat</h4>
    After you have modified <code>server.xml</code> and copied the digested
    password into <code>tomcat-users.xml</code>, restart Tomcat for this change to take effect.
<p>
<b>Exercise:</b> Do the above for the clear text password that you added to
    <code>tomcat-users.xml</code> earlier.  After you&#146;ve made the changes
and restarted Tomcat, test the change by going to
<a href="http://localhost:8080"> http://localhost:8080</a> and then
accessing the Manager application.
The behavior of Tomcat should be the same as when you first added your password.
You know, however, that the digested password is being used as that is what
is stored in <code>tomcat-users.xml</code>.


<a name="ssl encryption" />
<h2> Using SSL Encryption </h2>

Using digest passwords eliminates the problem of storing passwords in clear text.

But it does not address the possibility of snooping on a connection to the server.
By enabling SSL on the server we require clients to SSL encode their requests.
This prevents network sniffers from acquiring sensitive information.

<p>
    Besides encoding information sent to the server, the SSL protocol also requires
    that the server authenticate to the client.  This is to prevent a spoof from
    pretending to be a trusted server and fraudulently obtaining sensitive
    information.  For this reason, to enable SSL it is first necessary to create
    an SSL certificate for the server, in this case Tomcat.  This is a credential that is passed to
    the client upon initiating a connection that certifies the server&#146;s identity.
    Among trusted sites, it is sufficient for the server to send a <q>self-signed</q>
    certificate, the creation of which is described here.  A self-signed certificate
    is not considered the most secure because there is no third party
    certificate authority vouching for the site.  If you are interested
    in using more secure certificates, see the subsection called <q>Upgrading SSL
    security level by creating a CA (Certificate Authority) signed key</q> under
    the Section
    <a href="productionAdvanced.html">Production Installation - Advanced</a>.


<p>
    The page <a href="http://tomcat.apache.org/tomcat-4.1-doc/ssl-howto.html">SSL Configuration HOW-TO</a>
    from the Tomcat documentation gives information about Tomcat and SSL. 

<h3> Enabling Secure Communication to Tomcat Via SSL Encryption </h3>
There are three tasks required to enable Tomcat to use SSL:
<ul>
    <li>Create a self-signed certificate</li>
    <li>Configure <code>server.xml</code> to use SSL Encryption</li>
    <li>Restart Tomcat</li>
</ul>
<h4>Creating a Self-Signed Certificate </h4>

To create a self-signed certificate, you must first create a <q>keystore</q> file
where certificates are stored.  Java provides a tool, called keytool, that
generates a self-signed certificate and puts in a keystore file.  The default
keystore filename is ${user_home}/.keystore.  However, this example will use
the filename $TOMCAT_HOME/conf/keystore-tomcat.

<p>
    To create a self-signed certificate and store it in
    $TOMCAT_HOME/conf/keystore-tomcat, execute this command:
<p>
    <code>
        /usr/java/jdk1.5.0_10/bin/keytool -genkey -alias tomcat -keyalg RSA -validity 365 -keystore $TOMCAT_HOME/conf/keystore-tomcat
    </code>
<p>
    The arguments to this command tell <code>keytool</code> to generate a key,
    make an entry for the keystore file identified by the alias "tomcat" (the
    alias used by Tomcat),   
    use the RSA encryption algorithm,
    create a certificate valid for 365 days,
    and put it in the keystore file called <code>$TOMCAT_HOME/conf/keystore-tomcat</code>.

<p>
    This command will generate this series of questions:

<pre>

Enter keystore password:  changeit

What is your first and last name?

  [Unknown]:  localhost

What is the name of your organizational unit?

  [Unknown]:  tomcat server

What is the name of your organization?

  [Unknown]:  Anne&#146;s Home

What is the name of your City or Locality?

  [Unknown]:  Boulder

What is the name of your State or Province?

  [Unknown]:  Colorado

What is the two-letter country code for this unit?

 [Unknown]:  US

Is CN=localhost, OU=tomcat server, O=Anne&#146;s Home, L=Boulder, ST=Colorado, C=US correct?

  [no]:  yes



Enter key password for &lt;Anne&gt;

        (RETURN if same as keystore password):

</pre>

<p>
    The default <code>keytool</code> password is <q>changeit</q>.  You must use this same
    password for both the keystore password and the key password for tomcat.
    Although it's not obvious, the <q>first and last name</q> should be the name of the server host machine.

<p>
    Note: The above output was generated when keytool was run as special user "tomcat".
In the context of this workshop we are running as user "workshop" so your output
will reflect that difference.
</p>
    <p>
<b>Exercise:</b> Create the keystore file.


<h4> Configure Tomcat to Use SSL Encryption     </h4>

Next, it is necessary to configure the tomcat server to use this new keystore file.
This requires another modification to <code>server.xml</code>.  In
<code>server.xml</code>  we will
<ol>
    <li>Redirect requests to port 8080 to port 8443, the secure port</li>
    <li>Create a Connector for port 8443</li>
</ol>

<p>
    To redirect requests to port 8443, find the Connector that uses port
    8080 and ensure that it has a <q>redirectPort</q> attribute having the
value <q>8443</q>.  It should look something like this:
<pre>
    &lt;!-- Define a non-SSL HTTP/1.1 Connector on port 8080 --&gt;
    &lt;Connector port="8080" maxHttpHeaderSize="8192"
        maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
        enableLookups="false" redirectPort="8443" acceptCount="100"
        connectionTimeout="20000" disableUploadTimeout="true" /&gt;

</pre>

<p>
    To create a Connector using port 8443, the SSL port, in <code>server.xml</code> find the
    Connector element that uses port 8443.  By default is commented out.
    Ensure that that Connector element is
    not commented out.  Also, to that element add the attribute
    <code>keystoreFile</code> and give the value of the path to the keystore
    file that we created above.  The result should look similar to this:

<pre>
    &lt;!-- Define a SSL HTTP/1.1 Connector on port 8443 --&gt;

    &lt;Connector port="8443" maxHttpHeaderSize="8192"
               maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
               enableLookups="false" disableUploadTimeout="true"
               acceptCount="100" scheme="https" secure="true"
               clientAuth="false" sslProtocol="TLS"
               keystoreFile="/opt/tomcat/conf/keystore-tomcat" /&gt;
</pre>
Note that links are not followed in the specification of the location of the
keystore file.  If Tomcat can't actually find the keystore file, it will
likely throw a <code>java.io.FileNotFoundException</code>, reported in the logs.

<p>
<b>Note, regarding Tomcat 6:</b> There is a difference between Tomcat 5 and Tomcat 6
    regarding enabling SSL.  Tomcat 6 uses the Apache Portable Runtime Library
    (APR) to <q>provide superior scalability, performance, and better integration
    with native server technologies</q>.  (See
    <a href="http://tomcat.apache.org/tomcat-6.0-doc/apr.html">
    Tomcat 6: Apache Portable Runtime and Tomcat</a> for more information.)
Use of the APR requires an additional element in <code>server.xml</code> to define
which SSL engine to use (or to disable SSL), like this:
<pre>
&lt;Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" /&gt;
</pre>
Note that this Listener is not used in Tomcat 5, so copying <code>server.xml</code> from a
Tomcat 5 to a Tomcat 6 installation is not recommended.
<p>
Furthermore, in Tomcat 6  the Connector element for port 8443 requires the <q>SSLEnabled</q> attribute be
set to true, like this:
<pre>
    &lt;Connector port="8443"  SSLEnabled="true" maxHttpHeaderSize="8192"
               maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
               enableLookups="false" disableUploadTimeout="true"
               acceptCount="100" scheme="https" secure="true"
               clientAuth="false" sslProtocol="TLS"
               keystoreFile="/opt/tomcat/conf/keystore-tomcat" /&gt;
</pre>
The <q>SSLEnabled</q> attribute is not used in Tomcat 5, so copying the entire Connector element
from a Tomcat 5 to a Tomcat 6 installation will not enable SSL, and may (and has) produce mysterious
behavior around access to protected resources.

<h4> Restart Tomcat    </h4>
    Finally, restart the Tomcat server to pick up these changes.
<p>
 After restarting Tomcat, you can use <code>netstat -an</code> command to
    check that the ports are correctly configured. You should see lines like:
<pre>
  TCP    127.0.0.1:8080         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:8443         0.0.0.0:0              LISTENING
</pre>

<p>
<b>Exercise:</b> Edit <code>server.xml</code> and configure Tomcat to use SSL.
Restart Tomcat, and connect via your browser:
 <a href="http://localhost:8080"> http://localhost:8080</a>.
<p>
Use of SSL is transparent, so you should see no difference.  If there is a problem,
however, you will likely be unable to restart Tomcat or connect successfully afterwards.

<a name="ssl tds remote mgmt" />
<h3> Enable SSL for TDS Remote Management</h3>
Exercise: Go to
<a href="http://localhost:8080/thredds/debug"> http://localhost:8080/thredds/debug</a>.
<p>
    If you've been following the exercises in this document at this point
    you will be prevented from accesssing this page.  You should get a message
    about access to the page being denied.
<p>
    At this point, even though we have configured Tomcat to use SSL encryption,
    we have not allowed anyone to have access to the protected TDS resources.
To provide access it is necessary to update the user database
<code>tomcat-users.xml</code> to include the role <code>tdsConfig</code> and to
add that as a role to authorized users.   Make your <code>tomcat-users.xml</code>
look something like this:
<pre>
&lt;tomcat-users&gt;
    &lt;role rolename="tdsConfig /&gt;
    &lt;role rolename="tdrAdmin /&gt;
    &lt;role rolename="manager" /&gt;
    &lt;user name="Anne" password="secret" roles="tdrAdmin,manager,tdsConfig" /&gt;
&lt;/tomcat-users&gt;
</pre>
Then restart Tomcat for this change to take effect.
<p>
Exercise: Test this change by going to
<a href="http://localhost:8080/thredds/debug"> http://localhost:8080/thredds/debug</a>.
You should get the TDS debug page.

<a name="tds no ssl"
<h3>Running TDS without SSL</h3>

If you are on a secure network and don't want to run with SSL enabled,
    edit <code>$TOMCAT_HOMEwebapps/thredds/WEB-INF/web.xml</code> and change all instances of
    <q>CONFIDENTIAL</q> to <q>NONE</q>.
<p>
Password authentication will then be done without SSL encryption.
    You will have to repeat this whenever you reinstall or upgrade <code>thredds.war</code>.

<a name="ssl for mgr app"
<h3> Enable SSL for the Manager Application</h3>

If you've been following the exercises in this tutorial, the Manager application
 is currently running though without SSL encryption.  In order to make this Manager
 security even stronger, we will reconfigure the Manager application to require this.
 First, some background:
 <p>

In order to create SSL protected areas of an application, it is necessary to
specify those protected areas.  This is done in a special file belonging to
the application,
called <code>&lt;application name&gt;/WEB-INF/web.xml</code> (relative to
the <code>webapps</code> directory), which
is provided with every application served by Tomcat.  For example, TDS provides
the file <code>$TOMCAT_HOME/webapps/thredds/WEB-INF/web.xml</code>, which is
preconfigured to require SSL encryption to get the remote management page.
The section of the file that does this is here:
<pre>
  &lt;!-- This allows "remote configuration":
    /thredds/debug gives access to various debug and status info.
    ThreddsDefault servlet aliases /thredds/root/ to "{tomcat_home}/webapps/thredds/"
    ThreddsDefault servlet aliases /thredds/dataDir/path to "dirLocation/" where path is mapped to dirLocation through a
      datasetRoot or datasetScan element in the catalog. --&gt;
  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;sensitive read access&lt;/web-resource-name&gt;
      &lt;url-pattern&gt;/debug&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/root/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/dataDir/*&lt;/url-pattern&gt;
      &lt;http-method&gt;GET&lt;/http-method&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
      &lt;role-name&gt;tdsConfig&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
    <u>&lt;user-data-constraint&gt;</u>
      <u>&lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;</u>
    <u>&lt;/user-data-constraint&gt;</u>
  &lt;/security-constraint&gt;
</pre>
It is the <code>user-data-constraint</code> element that requires port 8443 to be
used, thus requiring SSL encryption:
<pre>
    &lt;user-data-constraint&gt;
      &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
    &lt;/user-data-constraint&gt;
</pre>
<p>
We will put this same XML snippet in the <code>web.xml</code> file belonging
to the Manager application.
<p>
In the file <code>server/webapps/manager/WEB-INF/web.xml</code>, find this
<pre>
     &lt;!-- Define a Security Constraint on this Application --&gt;
  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;HTMLManger and Manager command&lt;/web-resource-name&gt;
      &lt;url-pattern&gt;/jmxproxy/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/html/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/list&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/sessions&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/start&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/stop&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/install&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/remove&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/deploy&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/undeploy&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/reload&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/save&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/serverinfo&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/status/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/roles&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/resources&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
       &lt;!-- NOTE:  This role is not present in the default users file --&gt;
       &lt;role-name&gt;manager&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
  &lt;/security-constraint&gt;

</pre>
(Actually, the role <q>manager</q> is now present in the default users file,
as we added it earlier.  You can now remove this out of date comment.)
<p>
Now add the <code>user-data-constraint</code> element, like this:
<pre>
     &lt;!-- Define a Security Constraint on this Application --&gt;
  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;HTMLManger and Manager command&lt;/web-resource-name&gt;
      &lt;url-pattern&gt;/jmxproxy/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/html/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/list&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/sessions&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/start&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/stop&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/install&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/remove&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/deploy&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/undeploy&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/reload&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/save&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/serverinfo&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/status/*&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/roles&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/resources&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;!-- Require use of port 8443 --&gt;
    <u>&lt;user-data-constraint&gt;</u>
        <u>&lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;</u>
    <u>&lt;/user-data-constraint&gt;</u>
    &lt;auth-constraint&gt;
      &lt;role-name&gt;manager&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
  &lt;/security-constraint&gt;

</pre>
Again, restart Tomcat for this change to take effect.

<hr width="100%">

<address>
    <img src="../images/thread.png" height="108" width="110">
    This document is maintained by Anne Wilson and was last updated
    on July 26, 2007.
<br>
    Send comments to <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS support</a>.
</address>

<p>&nbsp;</p>

</body></html>