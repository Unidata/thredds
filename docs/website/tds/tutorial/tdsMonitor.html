<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>The TdsMonitor Tool</title>
  <link rel="stylesheet" href="tutorial2.css" type="text/css"/>
  <script type="text/javascript" src="workshopNav.js"></script>
</head>
<body>

<h1>The <code>TdsMonitor</code> Tool</h1>

<div id="section">
  <h2><a name="setup">Setting up the <code>TdsMonitor</code> tool</a></h2>

  <p>The TdsMonitor tool allows you to fetch the TDS log files onto your local machine, and analyze them locally.</p>

  <h3>Setup</h3>
  <ol>
    <div id="note" class="reminder">
      <h4>Keep in Mind</h4>
      <ul>
        <li>Access logs are <em>tomcat-generated</em> and can be found in <code>${tomcat_home}/logs/</code>.</li>
        <li>Servlet logs are generated by the <em>TDS</em> and can be found in <code>${tomcat_home}/content/thredds/logs/</code>.</li>
      </ul>
    </div>
    <li>Make sure you have access logging enabled.</li>
    <ul>
      <li>Open <code>${tomcat_home}/conf/server.xml</code> and uncomment the <code>AccessLogValve</code> in the <code>Host</code>. Modify the
        <code>pattern</code> attribute as per these <a href="TDSMonitoringAndDebugging.html#access">instructions</a>.
      </li>
      <li><a href="http://localhost:8080/thredds/catalog.html">Browse your installation of the TDS</a> to generate some entries in the access logs.</li>
    </ul>
    <li>Make sure you have the <a href="TDSMonitoringAndDebugging.html#tds">TDS servlet logging</a> enabled.</li>
    <ul>
      <li>This is turned on by default in the <code>log4j.xml</code> file.</li>
    </ul>
    <li>Give yourself the access to the <code>TdsMonitor</code> tool.</li>
    <p>Modify <code>${tomcat_home}/conf/tomcat-users.xml</code> to add a new <code>role</code> with the <code>rolename</code> attribute of
      <code>tdsMonitor</code> and add this <code>role</code> to your list of <code>roles</code>:</p>

<pre>
&lt;tomcat-users&gt;      
  &lt;role rolename="manager"/&gt;
  &lt;role rolename="tdsConfig"/&gt;      
  <strong>&lt;role rolename="tdsMonitor"/&gt;</strong>
  &lt;user name="admin" password="e5e9fa1ba31ecd1ae84f75caaa474f3a663f05f4" 
        roles="manager,tdsConfig,<strong>tdsMonitor</strong>"/&gt;
&lt;/tomcat-users&gt;
</pre>
    <li>Download the <code>ToolsUI</code> jar file and start the <code>TdsMonitor</code> tool.</li>
    <p>Download the <a href="https://www.unidata.ucar.edu/downloads/netcdf-java/">ToolsUI.jar</a> file to some convenient place on your local drive.
    </p>
<pre>
<strong>$</strong> pwd
/home/tds

<strong>$</strong> ls -l
-rw-r--r-- 1 tds ustaff 26235155 Oct 18 20:44 toolsUI-4.5.jar 
</pre>

    <p>Start the <code>TdsMonitor</code> program by running the following command: </p>

<pre>
<strong>$</strong> java -Xmx4g -classpath toolsUI-4.5.jar thredds.ui.monitor.TdsMonitor
</pre>
    <p>You should see <code>TdsMonitor</code> start:</p>

    <p><img src="images/tdsMonitorStartup.png" width="800" height="450"></p>
    <li>Download the current logs files into the <code>TdsMonitor</code> tool.</li>
    <ol>
      <li>Type <code>localhost:8080</code> into the <code>server</code> comboBox</li>
      <li>Select all 3 buttons <code>access logs, server logs</code>, and <code>data roots</code>.</li>
      <li>Press <code>Download</code>

        <p>You should get a security challenge:</p>

        <p><img src="images/httpChallenge.png" alt="" width="432" height="178"></p></li>
      <li>Type in your username and password.</li>
      <li>You should see messages showing up in the text area:</li>
    </ol>
    <p><a href="images/tdsMonitorDownload.png" target="_blank"><img src="images/tdsMonitorDownload_small.png" width="800" height="338"></a></p>

    <p>The files will be stored in <code>$USER_HOME/tdsMonitor/localhost%3A8080</code>. For production servers, you will need to manage the large number of logs
      stored here.</p>

    <p>The server name will be stored permanently for future use. To remove unwanted servers, right click inside the <code>server</code> comboBox, select <code>Delete</code>,
      and then click on the server names you want to delete.</p>
  </ol>
</div>
<!-- end section -->


<div id="section">
  <h2><a name="access">Viewing the Tomcat access logs</a></h2>

  <p>Switch to the <code>AccessLogs</code> tab, and select<code> localhost:8080</code>, which will make the <code>Start Date</code> and <code>End Date</code>
    fields get filled out. Press the <code>get logs</code> button <img src="images/getlogsButt.png" width="28" height="28">, and the logs in the selected time
    range are read in:</p>

  <p><a href="images/AccessLogs.png" target="_blank"><img src="images/AccessLogs_small.png" width="800" height="260"></a></p>

  <p>Each log entry in the access logs is a row in the table. You can rearrange the columns by dragging on the column headers. You can sort by column by
    clicking on the column headers. </p>

  <p>Select a row, and right click to bring up the context menu. Choose &quot;<code>Resend URL</code>&quot; which takes you to the <code>UrlDump</code> screen.
    Choose &quot;<code>Get</code>&quot; and the URL will be resent to the server, and the results shown in the text area:</p>

  <p><a href="images/UrlDump.png" target="_blank"><img src="images/UrlDump_small.png" width="800" height="385"></a></p>

  <p>Go to the User tab, and reverse sort by count (click on <code>count</code> column header twice), to see a summary of log access records by IP address.
    Press the lookup DNS button <img src="images/dns.png" width="29" height="28"> to do reverse DNS lookup on the IP address (this is very slow, and you have to
    scroll the table to force a refresh).</p>

  <p><a href="images/Users.png" target="_blank"><img src="images/Users_small.png" width="800" height="385"></a></p>

  <p>Select a user, then right click to get the context menu. Select &quot;User requests&quot;, which takes you back to the LogTable screen, but only shows the
    logs that are from the selected user. Press <code>show All logs</code> button <img src="images/showAll.png" width="32" height="28"> to get back to showing
    all the logs.</p>

  <p>Similarly, the <code>Service</code> tab shows the logs summarized by service, and you can drill down to see the individual access calls for a specific
    service.</p>

  <p>Similarly, the <code>DataRoot </code> tab shows the logs summarized by data root, and you can drill down to see the individual access calls for a specific
    data root. For this to work correctly, you must have selected <code>data roots</code> in the ManageLogs when downloading. This will download<code> the
      dataroot file to $USER_HOME/tdsMonitor/localhost%3A8080/roots.txt</code>. You should refresh it whenever the data roots change on your server.</p>

  <p>Go to the TimeSeries tab:</p>

  <p><a href="images/timeSeries.png" target="_blank"><img src="images/timeSeries_small.png" width="800" height="385"></a></p>

  <p>This gives a summary of activity on your server for the selected time period, using 5 minute intervals. The total number of requests, total Mbytes sent,
    and Average Latency in each 5 minute interval are shown.</p>
</div>
<!-- end section -->


<div id="section">
  <h2><a name="servlet">Viewing the TDS servlet logs</a></h2>

  <p>The TDS Servlet logs are for debugging and are more low-level than the access logs. They are also bigger and you will want to be careful about examining a
    manageable subset of them at any one time.</p>

  <p>Switch to the <code>ServletLogs</code> tab, and select<code> localhost:8080</code>, which will make the <code>Start Date</code> and <code>End Date</code>
    fields get filled out. Press the <code>get logs</code> button <img src="images/getlogsButt.png" alt="" width="28" height="28">, and the logs in the selected
    time range are read in:</p>

  <p><a href="images/ServletLogs.png" target="_blank"><img src="images/ServletLogs_small.png" width="800" height="314"></a></p>

  <p>The LogTable shows the raw data. You almost always want to look just at the Merged logs, by choosing the <code>Merge</code> tab. For illustration purposes,
    we have switched to a larger set of logs from motherlode server:</p>

  <p><a href="images/Merge.png" target="_blank"><img src="images/Merge_small.png" width="800" height="314"></a></p>

  <p>The top table shows groups of logs which are continuous in their <code>reqSeq</code> numbers, so each group indicates that the TDS web application (and/or
    Tomcat) was restarted between the endDate and startDate of the subsequent group. Select one of these groups to see the logs that are in that group in the
    lower table.</p>

  <p>As with the access log tables, you can rearrange and sort on the columns. Reverse sort on the <code>extra</code> column (by clicking on it twice) to show
    the logs that have extra information. In this example:</p>

  <p><a href="images/extra.png" target="_blank"><img src="images/extra_small.png" width="800" height="315"></a></p>

  <p>Select one of the rows with extra information, and click on it to bring up the information about that request:</p>

  <p><a href="images/extraInfo.png" target="_blank"><img src="images/extraInfo_small.png" width="800" height="188"></a></p>

  <p>This shows all the information about request 294. The first line shows the information when the request first arrived at the server:</p>
  <table width="643" border="1">
    <tr>
      <td>2010-11-03T18:14:15</td>
      <td>ISO date/time of the request</td>
    </tr>
    <tr>
      <td>[312059]</td>
      <td>msecs since server start</td>
    </tr>
    <tr>
      <td>[294]</td>
      <td>request number</td>
    </tr>
    <tr>
      <td>INFO</td>
      <td>type of log message</td>
    </tr>
    <tr>
      <td>thredds.server.opendap.OpendapServlet</td>
      <td>servlet handling the request</td>
    </tr>
    <tr>
      <td>(174.100.87.24)</td>
      <td>IP address</td>
    </tr>
    <tr>
      <td><p>/thredds/dodsC/nexrad/level2/IDD/KCLE/</p>

        <p>20101103/Level2_KCLE_20101103_2356.ar2v.dds </p></td>
      <td>request path</td>
    </tr>
  </table>
  <p>The second two lines show warning messages from the IOSP that opened the file. In general, problems will be recorded here, and there may be times when
    Unidata support will ask you to forward this information to them in order to diagnose issues.</p>

  <p>The last line shows the closing message after the request has been completed:</p>
  <table width="644" border="1">
    <tr>
      <td width="261">2010-11-03T18:14:15</td>
      <td width="367">ISO date/time the request was completed</td>
    </tr>
    <tr>
      <td> [312336]</td>
      <td>msecs since server start</td>
    </tr>
    <tr>
      <td>[294]</td>
      <td>request number</td>
    </tr>
    <tr>
      <td>INFO</td>
      <td>type of log message</td>
    </tr>
    <tr>
      <td>thredds.server.opendap.OpendapServlet</td>
      <td>servlet handling the request</td>
    </tr>
    <tr>
      <td>200</td>
      <td>HTTP status return</td>
    </tr>
    <tr>
      <td>-1</td>
      <td>size in bytes of returned content</td>
    </tr>
    <tr>
      <td>227</td>
      <td>total request time in msecs</td>
    </tr>
  </table>
  <p>In this case, the result was handled successfully (status return 200), and took 227 msecs. The size is often not known in these logs, indicated by a -1. As
    you can see, all of the pertinent information is summarized in the table row. Looking at the complete information is usually only done to see what the
    &quot;extra&quot; log messages are.</p>

  <p>The <code>Undone</code> and <code>Misc</code> tabs are used to record messages that don't have a proper start and end message, and are generally only
    useful to TDS support.</p>
</div>
<!-- end section -->
</body>
</html>
