<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>TDS Monitoring and Debugging: Logs!</title>
  <link rel="stylesheet" href="tutorial2.css" type="text/css"/>
  <script type="text/javascript" src="workshopNav.js"></script>
</head>
<body>


<h1>TDS Monitoring and Debugging: Logs!</h1>


<div id="section">
  <h2><a name="context">What This Section Covers</a></h2>
  <img src="images/log.png" alt="Log! Everyone wants a log! You're gonna love it, Log!
    Come on and get your log! Everyone needs a Log!" style="float: right">

  <p>This section covers log files generated by Tomcat and the TDS for the purposes of monitoring and debugging:</p>
  <ul>
    <li><a href="#access">Tomcat Access Logs</a></li>
    <li><a href="#tds">Log Files Generated by the TDS</a></li>
  </ul>

  <p>You should be familiar with Tomcat, Java, and TDS <a href="Checklist.html">installation</a>; as well as <a href="tdsConfigChecklist.html">basic and
    advanced TDS configuration</a>.</p>
</div>
<!-- end section -->


<div id="section">
<h2><a name="access">Tomcat Access Logs</a></h2>

<h3>The Tomcat access log</h3>
<ul>
  <li>The access log records <em><strong>all</strong></em> requests processed by the server.</li>
  <li>As of Tomcat 7, enabled in Tomcat by default in <code>${tomcat_home}/conf/server.xml</code>.</li>
  <li>Information it contains is different from other logs in <code>${tomcat_home}/logs</code>.</li>
  <li>Used for monitoring who is using your server and as a way of obtaining "feedback" about the activity and performance of the server.</li>
  <li><em>In order to use the <code><a href="tdsMonitor.html">TdsMonitor</a></code> tool, you will need to change the default configuration of the <code>AccessLogValve</code>.</em>
  </li>
</ul>


<h3>Configuring Tomcat access logging for the <code>TdsMonitor</code></h3>
<ol>
  <li>Modify the <code>prefix</code>, <code>suffix</code>, and <code>pattern</code> attributes of the <code>AccessLogValve</code> element.</li>
  <p>Using your favorite editor open <code>${tomcat_home}/conf/server.xml</code>:</li>
<pre>
<strong>$</strong> vi server.xml
</pre>
  <p>Locate the <code>AccessLogValve</code> contained in the <code>Host</code> element (should be near the bottom of the file):</p>

<pre>
&lt;!-- Define the default virtual host
        Note: XML Schema validation will not work with Xerces 2.2.
--&gt;
&lt;Host name="localhost"  appBase="webapps"
      unpackWARs="true" autoDeploy="true"&gt;

  &lt;!-- SingleSignOn valve, share authentication between web applications
       Documentation at: /docs/config/valve.html --&gt;
  &lt;!--
  &lt;Valve className="org.apache.catalina.authenticator.SingleSignOn" /&gt;
  --&gt;

  <strong>&lt;!-- Access log processes all example.
    Documentation at: /docs/config/valve.html
    Note: The pattern used is equivalent to using pattern="common" --&gt;
    &lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
    prefix="localhost_access_log." suffix=".txt"
    pattern="%h %l %u %t &quot;%r&quot; %s %b" /&gt;</strong>

&lt;/Host&gt;
</pre>

  <p>Change the <code>prefix</code> and <code>suffix</code> attributes to customize the access log name. (The
    <code><a href="tdsMonitor.html">TdsMonitor</a></code> tool looks for log files to begin with <code>access</code>.)</p>
<pre>
prefix="access." 
suffix=".log"
</pre>

  <p>To provide more useful information about who is accessing the TDS, change the <code>pattern</code> element to customize the format of each log entry:</p>
<pre>
pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b &amp;quot;%{Referer}i&amp;quot; &amp;quot;%{User-Agent}i&amp;quot; %D"
</pre>
  <p>When you are finished with your edits, the <code>AccessLogValve</code> should look something like the following:</p>

<pre>
&lt;Valve className="org.apache.catalina.valves.AccessLogValve"
   directory="logs"  
   prefix="access." 
   suffix=".log"
   pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b &amp;quot;%{Referer}i&amp;quot; &amp;quot;%{User-Agent}i&amp;quot; %D" /&gt;
</pre>

  <li>Verify the changes to the access log have taken affect.</li>
  <p>Restart Tomcat and verify an access log has been generated in the <code>${tomcat_home}/logs/</code> directory:</li>
<pre>
<strong>$</strong> ls -l /home/tds/workshop/apache-tomcat-7.0.32/logs
<strong>-rw-r--r-- 1 tds workshop 0 Jul 24 12:25 access.2013-07-24.log</strong>
-rw-r--r-- 1 tds workshop  4270 Jul 24 12:26 catalina.2013-07-24.log
-rw-r--r-- 1 tds workshop 19095 Jul 24 12:26 catalina.out
-rw-r--r-- 1 tds workshop     0 Jul 24 12:25 host-manager.2013-07-24.log
-rw-r--r-- 1 tds workshop  3845 Jul 24 12:26 localhost.2013-07-24.log
-rw-r--r-- 1 tds workshop     0 Jul 15 09:39 localhost_access_log.2013-07-15.txt
-rw-r--r-- 1 tds workshop     0 Jul 24 12:25 manager.2013-07-24.log
</pre>
</ol>

<h3>Access log format</h3>


<p>The access log entry format we are using is almost identical to the standard <code>combined</code> logging format with an addition: the <code></small>
  %D</code> which is used for documenting the <em>Time taken to process the request, in millis</em> will appear at the end of each log entry:</p>

<pre>
pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b &amp;quot;%{Referer}i&amp;quot; &amp;quot;%{User-Agent}i&amp;quot; %D"
</pre>
<div id="note" class="info">
  <h4>Access log format</h4>

  <p>For more information on access log format configuration, see the Tomcat <a href="http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html">Valve
    Component</a> Documentation.</p>
</div>


<p>The above pattern makes use of the following codes:</p>

<ul class="little">
  <li><code>%h</code> - Remote host name (or IP address if resolveHosts is false)
  <li><code>%l</code> - Remote logical username from identd (always returns '-')
  <li><code>%u</code> - Remote user that was authenticated (if any), else '-'
  <li><code>%t</code> - Date and time, in Common Log Format
  <li><code>%r</code> - First line of the request (method and request URI)
  <li><code>%s</code> - HTTP status code of the response
  <li><code>%b</code> - Bytes sent, excluding HTTP headers, or '-' if zero
  <li><code>%D</code> - Time taken to process the request, in millis
</ul>
<p>The above pattern translates into:</p>
<pre>
127.0.0.1 - admin [21/Oct/2012:12:31:59 -0600] "GET /manager/html HTTP/1.1" 200 17578 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:10.0.7) Gecko/20120829 Firefox/10.0.7" 8
</pre>


<p>Another way of looking at it:</p>
<table>
  <tr>
    <td>
      Remote host
    </td>
    <td>
      <code>127.0.0.1</code>
    </td>
  </tr>
  <tr>
    <td>
      Remote logical username from identd
    </td>
    <td>
      <code> -</code>
    </td>
  </tr>
  <tr>
    <td>
      Authenticated user
    </td>
    <td>
      <code>admin</code>
    </td>
  </tr>
  <tr>
    <td>
      Time and date of request
    </td>
    <td>
      <code>[21/Oct/2012:12:31:59 -0600]</code>
    </td>
  </tr>
  <tr>
    <td>
      HTTP request method
    </td>
    <td>
      <code>GET</code>
    </td>
  </tr>
  <tr>
    <td>
      Request URI
    </td>
    <td>
      <code>/manager/html </code>
    </td>
  </tr>
  <tr>
    <td>
      Protocol used
    </td>
    <td>
      <code>HTTP/1.1</code>
    </td>
  </tr>
  <tr>
    <td>
      HTTP server response
    </td>
    <td>
      <code>200</code>
    </td>
  </tr>
  <tr>
    <td>
      Bytes transferred
    </td>
    <td>
      <code>17578</code>
    </td>
  </tr>
  <tr>
    <td>
      Referer
    </td>
    <td>
      <code>-</code>
    </td>
  </tr>
  <tr>
    <td>
      User Agent
    </td>
    <td>
      <code>Mozilla/5.0 (X11; Linux x86_64; rv:10.0.7) Gecko/20120829 Firefox/10.0.7</code>
    </td>
  </tr>
  <tr>
    <td>
      Response time (in millis)
    </td>
    <td>
      <code>8</code>
    </td>
  </tr>
</table>


</div>
<!-- end Access Logs section -->


<div id="section">
<h2><a name="tds">Log Files Generated by the TDS</a></h2>


<h3>Introducing the TDS logging directory: <code>${tomcat_home}/content/thredds/logs</code></h3>


<div id="note" class="reminder">
  <h4>Keep in Mind</h4>

  <p>There are <strong>two</strong> locations of log files you will reference:</p>
  <ol class="little">
    <li><code>${tomcat_home}/logs/</code> is where you go to look at <em>Tomcat-generated</em> log files; and</li>
    <li>the TDS logging directory which is where you go to look at <em>TDS-generated</em> log files.</li>
  </ol>
</div>


<p>The log files generated by the TDS are located in the <code>${tomcat_home}/content/thredds/logs</code> directory: </p>

<table>
  <tr>
    <th>
      Log file
    </th>
    <th>
      Data the file contains
    </th>
  </tr>
  <tr>
    <td>
      <code>catalogInit.log</code>
    </td>
    <td>
      contains log messages related to configure catalog parsing on startup
    </td>
  </tr>
  <tr>
    <td>
      <code>threddsServlet.log</code>
    </td>
    <td>
      contains log messages used for debugging
    </td>
  </tr>
  <tr>
    <td>
      <code>serverStartup.log</code>
    </td>
    <td>
      contains log messages from the initialization of the TDS
    </td>
  </tr>
  <tr>
    <td>
      <code>fmrc.log</code>
    </td>
    <td>
      contains log messages specific FMRC collections
    </td>
  </tr>
  <tr>
    <td>
      <code>cache.log</code>
    </td>
    <td>
      contains log messages related to TDS object and file caching
    </td>
  </tr>
  <tr>
    <td>
      <code>featureCollectionScan.log</code>
    </td>
    <td>
      contains log messages related to feature collections
    </td>
  </tr>
</table>

<h3>About the <code>threddsServlet.log</code></h3>
<ul>
  <li>Enabled by default.</li>
  <li>Log messages for all requests handled by the TDS.</li>
  <li>By default is configured to rotate every hour. Old log files are re-named with the <code>threddsServlet.log.&lt;yyyy-mm-dd-HH&gt;</code> pattern.</li>
  <li>Used for debugging and troubleshooting issues with the TDS.</li>
  <li>May be asked to send information from <code>threddsServlet.log</code> to the TDS development team when seeking support.</li>
</ul>


<h3><code>threddsServlet.log</code> log format</h3>


<ol>
  <li>Look at the logging configurations for <code>threddsServlet.log</code>.</li>
  <p>Navigate to the unpacked <code>thredds</code> directory in <code>${tomcat_home}/webapps/WEB-INF</code>, and view the <code>log4j.xml</code>: </p>
<pre>
<strong>$</strong> cd /home/tds/workshop/apache-tomcat-7.0.32/webapps/thredds/WEB-INF
<strong>$</strong> less log4j.xml
</pre>
  <p>The TDS uses the OpenSource Apache <code>Log4J</code> library (hence, the name of the file: <code>log4j.xml</code>). </p>

  <p>Find the first <em>uncommented</em> <code>Appender</code> element with a name of <code>threddsServlet</code> and a class of <code>org.apache.log4j.DailyRollingFileAppender</code>,
    and note the <code>ConversionPattern</code>: </p>
<pre>
  &lt;appender name="threddsServlet" class="org.apache.log4j.DailyRollingFileAppender"&gt;
    &lt;param name="File" value="${tds.log.dir}/threddsServlet.log"/&gt;
    &lt;param name="DatePattern" value=".yyyy-MM-dd-HH"/&gt;
    &lt;layout class="org.apache.log4j.PatternLayout"&gt;
      <strong>&lt;param name="ConversionPattern" value="%d{yyyy-MM-dd'T'HH:mm:ss.SSS Z} [%10r][%8X{ID}] %-5p - %c - %m%n"/&gt;</strong>
      &lt;!--param name="ConversionPattern" value="%d{ISO8601} [%10r - %10X{ID}] %-5p - %c - %m%n"/--&gt;
    &lt;/layout&gt;
  &lt;/appender&gt;     
</pre>
  <li>Examine the log format being applied to the <code>threddsServlet.log</code> file.</li>
  <p>The <code>ConversionPattern</code> parameter specifies the <code>Log4J</code> pattern used to format the entries of the <code>threddsServlet.log</code>
    file:</p>
<pre>
value="%d{yyyy-MM-dd'T'HH:mm:ss.SSS Z} [%10r][%8X{ID}] %-5p - %c - %m%n" 
</pre>
  <div id="note" class="info">
    <h4><code>Log4J</code> library</h4>

    <p>For more information on the <code>Log4J</code> library, consult the online <a href="http://logging.apache.org/log4j/">documentation</a>.</p>
  </div>
  <p>The above pattern makes use of the following <code>Log4J</code> codes:</p>

  <ul class="little">
    <li><code>%d{yyyy-MM-dd'T'HH:mm:ss.SSS Z}</code> - Date and time
    <li><code>%10r</code> - Time, in millis, since Tomcat startup
    <li><code>%8X{ID}</code> - Transaction ID
    <li><code>%-5p</code> - Logging level (options are <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>, and <code>FATAL</code>)
    <li><code>%c</code> - Location in the TDS code where the message was generated
    <li><code>%m</code> - Content of the log message
    <li><code>%n</code> - Newline character
  </ul>


  <p>The above pattern translates into:</p>
<pre>
2012-10-21T12:26:23.727 -0600 [      5887][       8] INFO  - threddsServlet - Remote host: 127.0.0.1 - Request: "GET /thredds/catalog/testAll/catalog.html?dataset=testDatasetScan/2004050412_eta_211.nc HTTP/1.1"
</pre>


  <p>Another way of looking at it:</p>
  <table>
    <tr>
      <td>
        Time and date
      </td>
      <td>
        <code>2012-10-21T12:26:23.727 -0600</code>
      </td>
    </tr>
    <tr>
      <td>
        The number of milliseconds since the server was started
      </td>
      <td>
        <code>[ 5887]</code>
      </td>
    </tr>
    <tr>
      <td>
        Request ID
      </td>
      <td>
        <code>[ 8]</code>
      </td>
    </tr>
    <tr>
      <td>
        Logging level
      </td>
      <td>
        <code>INFO</code>
      </td>
    </tr>
    <tr>
      <td>
        Location in the TDS code where the message was generated
      </td>
      <td>
        <code>threddsServlet</code>
      </td>
    </tr>
    <tr>
      <td>
        Content of the log message
      </td>
      <td>
        <code>Remote host: 127.0.0.1 - Request: "GET /thredds/catalog/testAll/catalog.html?dataset=testDatasetScan/2004050412_eta_211.nc HTTP/1.1"</code>
      </td>
    </tr>

  </table>

</ol>

<h3>Transaction bracketing in <code>threddsServlet.log</code></h3>
<ul>
  <li>Each HTTP request (or transaction) handled by the TDS results in at least two log messages:</li>
  <ul style="margin-left: 60px">
    <li> a message indicating the <strong>start of the transaction</strong>; and</li>
    <li>a message indicating the <strong>end of the transaction</strong>.</li>
  </ul>
  <li>Between the start and end messages, there may be other entries for this same request (e.g., <code>DEBUG</code>, <code>WARN</code>, <code>ERROR</code>,
    etc.).
  </li>

  <li>All log messages for the same request will have the same request ID.</li>
  <li>Log messages from multiple requests can be interspersed in the log file.</li>
  <li>When tracking down an error, it is useful to find a specific example of a request that causes that error and extract all the log messages for that
    request.
  </li>
</ul>

<h3>Start of transaction</h3>

<p>The main message in a start of transaction log message includes:</p>
<ul>
  <li>IP address of the requester; and</li>
  <li>request being made.</li>
</ul>
<p>For example:</p>
<pre>
... Remote host: <strong>128.117.140.75</strong> - Request: "<strong>GET /thredds/catalog.html HTTP/1.1</strong>"
</pre>

<h3>End of transaction</h3>

<p>The main message in a end of transaction log message includes:</p>
<ul>
  <li>server response code for the response;</li>
  <li>size of the response body in bytes; and</li>
  <li>time (in milliseconds) to handle the request.</li>
</ul>
<p>For example:</p>
<pre>
... Request Completed - <strong>200</strong> - <strong>3403</strong> - <strong>1</strong>
</pre>
<p>Most end of transaction messages include a status code that matches a standard HTTP status code. However, when the client breaks the
  connection or a request is forwarded to another TDS internal service, one of three TDS specific status codes are used:</p>

<ul class="little">
  <li><code>"1000 (Client Abort)"</code> - the connection to the client was broken;</li>
  <li><code>"1001 (Forwarded)"</code> - the request was forwarded to another TDS internal service; or</li>
  <li><code>"1002 (Forward Failed)"</code> - an attempt was made but failed to forward the request to another TDS internal service.</li>
</ul>

<p>If the request is forwarded successfully, another set of transaction messages should be initiated with the ending message containing a standard HTTP status
  code. If forwarding the request fails, another set of transaction message may or may not be initiated and the entry in the access log will probably either log
  a <code>404 (File Not Found)</code> or a <code>500 (Internal Server Error)</code> HTTP status code.</p>


<h3>Looking at <code>threddsServlet.log</code> data</h3>

<p>Here is an example of some log messages from a request that resulted in error messages:</p>
<pre>
2013-07-22T09:21:02.229 -0600 [1114883517][ <strong>7948911</strong>] INFO  - threddsServlet - Remote host: 173.165.244.157 - Request: "GET /thredds/wms/grib/NCEP/GFS/Global_0p5deg/GFS-Global_0p5deg-20130722/best2013-07-22T12:00:00Z?
LAYERS=Temperature_isobaric&FORMAT=image%2Fpng&TRANSPARENT=TRUE&VERSION=1.3.0&STYLES=boxfill2Frainbow&COLOR
SCALERANGE=270%2C315&ELEVATION=100000&EXCEPTIONS=INIMAGE&SERVICE=WMS&REQUEST=GetMap&TIME=2013-07-22T12%3A00
%3A00.000Z&CRS=EPSG%3A3857&BBOX=-10644926.305625,5635549.220625,-10331840.237812,5948635.2884375&WIDTH=256&
HEIGHT=256 HTTP/1.1"

2013-07-22T09:21:02.233 -0600 [1114883521][ 7948912] INFO  - threddsServlet - Remote host: 173.165.244.157 - Request: "GET /thredds/wms/grib/NCEP/GFS/Global_0p5deg/GFS-Global_0p5deg-20130722/best2013-07-22T12:00:00Z?LAYERS=Temperature_isobaric&FORMAT=image%2Fpng&TRANSPARENT=TRUE&VERSION=1.3.0&STYLES=boxfill2Frainbow&COLOR
SCALERANGE=270%2C315&ELEVATION=100000&EXCEPTIONS=INIMAGE&SERVICE=WMS&REQUEST=GetMap&TIME=2013-07-22T12%3A00
%3A00.000Z&CRS=EPSG%3A3857&BBOX=-10644926.305625,5322463.1528125,-10331840.237812,5635549.220625&WIDTH=256&
HEIGHT=256 HTTP/1.1"

2013-07-22T09:21:02.247 -0600 [1114883535][ 7948897] INFO  - threddsServlet - Request Completed - 200 - -1 - 186

2013-07-22T09:21:02.364 -0600 [1114883652][ 7948900] INFO  - threddsServlet - Request Completed - 200 - -1 - 221

2013-07-22T09:21:02.376 -0600 [1114883664][ 7948913] INFO  - threddsServlet - Remote host: 68.16.167.238 - Request: "GET /thredds/catalog/nexrad/level2/KDGX/20130722/latest.xml HTTP/1.1"

2013-07-22T09:21:03.110 -0600 [1114884398][ 7948914] INFO  - threddsServlet - Remote host: 96.126.114.65 - Request: "GET /thredds/fileServer//nexrad/level3/NST/AMA/20130722/Level3_AMA_NST_20130722_0032.nids HTTP/1.0"

2013-07-22T09:21:03.128 -0600 [1114884416][ 7948914] INFO  - threddsServlet - Request Completed - 200 - 519 - 18

2013-07-22T09:21:03.174 -0600 [1114884462][ 7948915] INFO  - threddsServlet - Remote host: 96.126.114.65 - Request: "GET /thredds/fileServer//nexrad/level3/NST/HGX/20130722/Level3_HGX_NST_20130722_1515.nids HTTP/1.0"

2013-07-22T09:21:03.181 -0600 [1114884469][ 7948915] INFO  - threddsServlet - Request Completed - 200 - 525 - 7

2013-07-22T09:21:03.190 -0600 [1114884478][ <strong>7948911</strong>] ERROR - thredds.server.wms.ThreddsWmsController - dispatchWmsRequest(): IOException:
java.io.IOException: java.lang.NullPointerException
        at thredds.server.wms.ThreddsScalarLayer.readHorizontalPoints(ThreddsScalarLayer.java:189)
        at uk.ac.rdg.resc.ncwms.controller.AbstractWmsController.readDataGrid(AbstractWmsController.java:1365)
        at uk.ac.rdg.resc.ncwms.controller.AbstractWmsController.getMap(AbstractWmsController.java:515)
        at thredds.server.wms.ThreddsWmsController.dispatchWmsRequest(ThreddsWmsController.java:179)
...
        at java.lang.Thread.run(Thread.java:722)
Caused by: java.lang.NullPointerException

2013-07-22T09:21:03.199 -0600 [1114884487][ 7948913] INFO  - threddsServlet - Request Completed - 200 - -1 - 823

2013-07-22T09:21:03.200 -0600 [1114884488][ 7948916] INFO  - threddsServlet - Remote host: 96.126.114.65 - Request: "GET /thredds/fileServer//nexrad/level3/NST/MLB/20130722/Level3_MLB_NST_20130722_1517.nids HTTP/1.0"

2013-07-22T09:21:03.200 -0600 [1114884488][ 7948903] INFO  - threddsServlet - Request Completed - 200 - -1 - 1045

2013-07-22T09:21:03.206 -0600 [1114884494][ 7948916] INFO  - threddsServlet - Request Completed - 200 - 1058 - 6

2013-07-22T09:21:03.229 -0600 [1114884517][ <strong>7948911</strong>] INFO  - threddsServlet - Request Completed - 500 - -1 - 1000
</pre>

<div id="note" class="reminder">
  <h4>Keep in Mind</h4>

  <p>Log messages from multiple requests can be interspersed in the log file. </p>
</div>

<p>In the above example, note:

<p>
<ul>
  <li>the request ID (<strong>7948911</strong>) matches in all messages;</li>
  <li>the ERROR message contains a stack trace; and</li>
  <li>the status code in the end of transaction message is <code>500 (Internal Server Error)</code> .</li>
</ul>

</div>
<!-- end TDS Logs section -->


<script src="https://docs.unidata.ucar.edu/js/tds46_add_in.js" type="text/javascript"></script>
</body>
</html>

